# SBAS Attendance System - Collections & Workflow Documentation
**Last Updated**: January 29, 2026  
**Project**: sbas_attendance (Smart Building Attendance System)  
**Platform**: Flutter + Firebase Firestore

---

## ğŸ“Š Table of Contents
1. [Firestore Collections Overview](#firestore-collections-overview)
2. [Collection Details & Fields](#collection-details--fields)
3. [Data Workflow](#data-workflow)
4. [User Authentication Flow](#user-authentication-flow)
5. [Attendance Marking Workflow](#attendance-marking-workflow)
6. [Data Relationships](#data-relationships)
7. [System Metadata & Configuration](#system-metadata--configuration)

---

## ğŸ”¥ Firestore Collections Overview

The system uses the following main collections in Cloud Firestore:

| Collection | Purpose | Primary Keys | Access Pattern |
|-----------|---------|-------------|-----------------|
| `users` | Base user information (deprecated, use student/faculty) | `uid` | Single read |
| `students` | Student account information and metadata | `uid` | Single read by UID |
| `faculty` | Faculty account information and metadata | `uid` | Single read by UID |
| `attendance` | All attendance records | Auto-generated ID | Query by roll number/date range |
| `attendance_summaries` | Pre-calculated attendance statistics | Document per student | Single read |
| `academic_records` | Student's academic progress and grades | Document per student | Single read |
| `branch_subjects` | Subjects taught per branch-year combination | `{branch}_{year}` | Single read |
| `faculty_timetables` | Faculty schedule and teaching assignments | `facultyId` | Single read |
| `system_metadata` | System-wide configuration and constants | `class_structure` | Single read |

---

## ğŸ“‹ Collection Details & Fields

### 1. **students Collection**
**Purpose**: Store all student account information  
**Document ID**: Firebase UID (from Firebase Auth)  
**Access**: Faculty reads student data; Students read own data  

#### Fields:
```json
{
  "id": "students_doc_id",           // String - Internal document ID (same as Firebase UID)
  "uid": "firebase_uid_123",         // String - Firebase Authentication UID
  "name": "John Doe",                // String - Full name
  "rollNumber": "2024001",           // String - Unique student roll number
  "email": "john@university.edu",    // String - University email
  "department": "CSE",               // String - Branch/Department code (e.g., CSE, AIML, ECE)
  "year": 4,                         // Number - Academic year (1-4)
  "section": "A",                    // String - Class section (A, B, C)
  "phoneNumber": "9876543210",       // String (Optional) - Contact number
  "profileImageUrl": "https://...",  // String (Optional) - Profile picture URL
  "enrolledSubjects": [              // Array - Subject codes student is enrolled in
    "CS101",
    "CS102",
    "CS103"
  ],
  "createdAt": "2024-01-15T10:30:00Z" // Timestamp - Account creation date
}
```

**Usage in Codebase**:
- Model: [models/student_model.dart](lib/models/student_model.dart)
- Read in: Student dashboard, Profile screen, ID card generation
- Updated in: Student profile controller

---

### 2. **faculty Collection**
**Purpose**: Store all faculty account information  
**Document ID**: Firebase UID (from Firebase Auth)  
**Access**: Faculty read own data; System reads for validation  

#### Fields:
```json
{
  "id": "faculty_doc_id",            // String - Internal document ID (same as Firebase UID)
  "uid": "firebase_uid_456",         // String - Firebase Authentication UID
  "name": "Dr. Jane Smith",          // String - Full name
  "employeeId": "FAC2024001",        // String - Unique faculty ID
  "email": "jane@university.edu",    // String - University email
  "department": "CSE",               // String - Department code
  "phoneNumber": "9876543211",       // String (Optional) - Contact number
  "profileImageUrl": "https://...",  // String (Optional) - Profile picture URL
  "assignedSubjects": [              // Array - Subject codes assigned to faculty
    "CS101",
    "CS102"
  ],
  "createdAt": "2023-01-15T10:30:00Z" // Timestamp - Account creation date
}
```

**Usage in Codebase**:
- Model: [models/faculty_model.dart](lib/models/faculty_model.dart)
- Read in: Faculty dashboard, setup controller, timetable screen
- Queried in: AttendanceService for faculty name in attendance records

---

### 3. **attendance Collection**
**Purpose**: Store all individual attendance records  
**Document ID**: Auto-generated by Firestore  
**Access**: Faculty writes; Students read own records  
**Query Patterns**: 
- By student roll number (array-contains)
- By date range
- By subject code
- By faculty ID

#### Fields:
```json
{
  "id": "doc_id_12345",              // String - Document ID from Firestore
  
  // IDENTIFICATION
  "subjectCode": "CS101",            // String - Subject code
  "subjectName": "Programming",      // String - Subject name
  "facultyId": "fac_uid_123",        // String - Faculty Firebase UID conducting the class
  "facultyName": "Dr. Jane Smith",   // String - Faculty name
  
  // TIME & DATE
  "timestamp": "2024-01-20T09:00:00Z", // Timestamp - Exact time of attendance marking
  "date": "2024-01-20",              // String - Date in YYYY-MM-DD format (for queries)
  "periodNumber": 1,                 // Number - Period number (1-7)
  "periodCount": 1,                  // Number - Duration in hours (1 for theory, 2-3 for labs)
  "isLab": false,                    // Boolean - Whether this is a lab session
  
  // STUDENT LIST
  "enrolledStudentIds": [            // Array - All student roll numbers in the class
    "2024001",
    "2024002",
    "2024003"
  ],
  "presentStudentIds": [             // Array - Roll numbers of students marked present
    "2024001",
    "2024003"
  ],
  
  // CLASS METADATA
  "branch": "CSE",                   // String - Department/Branch
  "section": "A",                    // String - Section
  "year": 4,                         // Number - Academic year
  
  // OPTIONAL
  "location": "Room 101",            // String (Optional) - Class location
  "notes": "Some notes"              // String (Optional) - Additional notes
}
```

**Key Queries**:
```dart
// Get attendance for a specific student
collection('attendance')
  .where('enrolledStudentIds', arrayContains: 'rollNo')
  .orderBy('timestamp', descending: true)

// Get attendance for a date range
collection('attendance')
  .where('enrolledStudentIds', arrayContains: 'rollNo')
  .where('date', isGreaterThanOrEqualTo: startStr)
  .where('date', isLessThanOrEqualTo: endStr)

// Get subject-wise attendance (all records then filtered in app)
collection('attendance')
  .where('enrolledStudentIds', arrayContains: 'rollNo')
```

**Usage in Codebase**:
- Model: [models/attendance_model.dart](lib/models/attendance_model.dart)
- Service: [services/attendance_service.dart](lib/services/attendance_service.dart)
- Write in: Faculty scanner, setup controller
- Read in: Student attendance views, dashboard, reports

---

### 4. **attendance_summaries Collection**
**Purpose**: Store pre-calculated attendance statistics per student  
**Document ID**: Student roll number  
**Access**: Students read own; Faculty reads for reports  
**Update**: Updated after each attendance marking session  

#### Fields:
```json
{
  // Document ID: "2024001" (student roll number)
  
  "studentId": "uid_123",            // String - Student Firebase UID
  "rollNumber": "2024001",           // String - Student roll number
  "studentName": "John Doe",         // String - Student name
  "totalClasses": 45,                // Number - Total classes attended+absent
  "presentClasses": 38,              // Number - Classes marked present
  "absentClasses": 7,                // Number - Classes marked absent (totalClasses - presentClasses)
  "lastUpdated": "2024-01-20T15:30:00Z", // Timestamp - When this summary was last calculated
  
  "subjectWiseSummary": {            // Object - Per-subject statistics
    "CS101": {
      "subjectName": "Programming",
      "attended": 15,
      "total": 18,
      "percentage": 83.33
    },
    "CS102": {
      "subjectName": "Data Structures",
      "attended": 14,
      "total": 16,
      "percentage": 87.50
    }
  },
  
  "monthlyBreakdown": {              // Object - Month-by-month statistics
    "2024-01": {
      "classes": 8,
      "present": 7,
      "absent": 1
    },
    "2024-02": {
      "classes": 12,
      "present": 10,
      "absent": 2
    }
  }
}
```

**Usage in Codebase**:
- Read in: [AttendanceSummaryReader](lib/services/attendance_summary_reader.dart)
- Displayed in: Student dashboard, attendance overview
- Updated in: Faculty setup after attendance submission

---

### 5. **academic_records Collection**
**Purpose**: Store academic progress, GPA, and grades  
**Document ID**: Student roll number  
**Access**: Students read own; Faculty reads for verification  

#### Fields:
```json
{
  // Document ID: "2024001" (student roll number)
  
  "studentId": "uid_123",            // String - Student Firebase UID
  "rollNumber": "2024001",           // String - Student roll number
  "studentName": "John Doe",         // String - Student name
  "department": "CSE",               // String - Department
  "year": 4,                         // Number - Current academic year
  
  "semesters": [                     // Array of semester records
    {
      "semester": 7,
      "cgpa": 8.5,
      "sgpa": 8.7,
      "courses": [
        {
          "code": "CS101",
          "name": "Programming",
          "credits": 4,
          "grade": "A",
          "points": 4.0
        }
      ]
    }
  ],
  
  "overallCGPA": 8.4,                // Number - Cumulative GPA
  "totalCreditsEarned": 120,         // Number - Total credits completed
  "totalCreditsRequired": 140,       // Number - Total credits needed for degree
  "lastUpdated": "2024-01-20T10:00:00Z" // Timestamp - Last update date
}
```

**Usage in Codebase**:
- Read in: Student ID card, student dashboard
- Reference: [student_id_controller.dart](lib/student/id_card/student_id_controller.dart)
- Display: Shows grades and academic status

---

### 6. **branch_subjects Collection**
**Purpose**: Store subjects offered per branch-year combination  
**Document ID**: Format: `{BRANCH}_{YEAR}` (e.g., "CSE_4", "AIML_3")  
**Access**: Faculty reads for class selection; Admin writes  
**Query**: Single document read per class selection  

#### Fields:
```json
{
  // Document ID: "CSE_4" (CSE department, 4th year)
  
  "branch": "CSE",                   // String - Department code
  "year": 4,                         // Number - Academic year
  "section": "A",                    // String - Section code
  
  "subjects": [                      // Array of subject objects
    {
      "code": "CS101",
      "subjectName": "Programming",
      "credits": 4,
      "department": "CSE",
      "semester": 7,
      "isLab": false,
      "periodCount": 1,
      "description": "Introduction to programming"
    },
    {
      "code": "CS105",
      "subjectName": "Database Lab",
      "credits": 2,
      "department": "CSE",
      "semester": 7,
      "isLab": true,
      "periodCount": 3,
      "description": "Hands-on database management"
    }
  ]
}
```

**Usage in Codebase**:
- Read in: [FacultySetupController](lib/faculty/setup/faculty_setup_controller.dart)
- Loads subjects for class selection dropdown
- Maps subject codes to names and period counts
- Display format: "Programming (Theory)" or "Database Lab (Lab - 3 hrs)"

---

### 7. **faculty_timetables Collection**
**Purpose**: Store faculty teaching schedules  
**Document ID**: Faculty Firebase UID  
**Access**: Faculty reads own; Admin writes  
**Update**: Manually updated by admin  

#### Fields:
```json
{
  // Document ID: "fac_uid_123" (Faculty Firebase UID)
  
  "facultyId": "fac_uid_123",        // String - Faculty Firebase UID
  "facultyName": "Dr. Jane Smith",   // String - Faculty name
  "department": "CSE",               // String - Department
  
  "timetable": {                     // Object - Day-wise schedule
    "Monday": [                      // Array of classes for each day
      {
        "periodNumber": 1,
        "subjectCode": "CS101",
        "subjectName": "Programming",
        "branch": "CSE",
        "year": 4,
        "section": "A",
        "startTime": "09:00",
        "endTime": "10:00"
      },
      {
        "periodNumber": 2,
        "subjectCode": "CS102",
        "subjectName": "Data Structures",
        "branch": "CSE",
        "year": 3,
        "section": "B",
        "startTime": "10:00",
        "endTime": "11:00"
      }
    ],
    "Tuesday": [],
    "Wednesday": [],
    "Thursday": [],
    "Friday": []
  },
  
  "lastUpdated": "2024-01-15T14:30:00Z" // Timestamp - When schedule was last updated
}
```

**Usage in Codebase**:
- Read in: [TimetableController](lib/faculty/timetable/timetable_controller.dart)
- Display in: Faculty timetable screen
- Referenced in: Faculty dashboard for quick class view
- Method: `FirestoreService.getFacultyTimetable(facultyId)`

---

### 8. **system_metadata Collection**
**Purpose**: Store system-wide configuration and constants  
**Document ID**: Specific keys like "class_structure"  
**Access**: Read-only for app; Admin writes configuration  
**Cost**: Minimal (single small document reads)  

#### Document: `class_structure`
```json
{
  // Document ID: "class_structure"
  
  "years": [1, 2, 3, 4],            // Array - Academic years in institution
  "branches": [                      // Array - All branch/department codes
    "CSE",
    "AIML",
    "ECE",
    "MECH"
  ],
  "sections": [                      // Array - Section codes
    "A",
    "B",
    "C"
  ],
  "maxPeriods": 7,                  // Number - Maximum periods per day
  "periodDuration": 60,             // Number - Minutes per period
  "academicYear": "2023-24",        // String - Current academic year
  "lastUpdated": "2024-01-01T00:00:00Z" // Timestamp - Configuration last updated
}
```

**Usage in Codebase**:
- Read in: [FacultySetupController.loadInitialData()](lib/faculty/setup/faculty_setup_controller.dart)
- Provides dropdowns for year, branch, section selection
- Cost-efficient: Single read loads all metadata
- Update: One-time at app startup

---

## ğŸ”„ Data Workflow

### **Workflow Diagram: End-to-End Attendance Process**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OVERALL SYSTEM FLOW                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. STARTUP & AUTHENTICATION
   â””â”€â†’ App launches â†’ SplashScreen
       â”œâ”€â†’ User logged out â†’ LoginScreen
       â”‚   â””â”€â†’ Enter credentials â†’ Auth Server verification
       â”‚       â””â”€â†’ Firebase custom token issued
       â”‚           â””â”€â†’ User signed into Firebase Auth
       â”‚
       â””â”€â†’ User logged in â†’ RoleRouter
           â”œâ”€â†’ Student role â†’ StudentShell (4-tab interface)
           â””â”€â†’ Faculty role â†’ FacultyShell (3-tab interface)

2. STUDENT WORKFLOW
   â”œâ”€â†’ StudentDashboard
   â”‚   â””â”€â†’ Reads: students collection (own uid)
   â”‚   â””â”€â†’ Reads: attendance_summaries (own roll number)
   â”‚   â””â”€â†’ Shows: Attendance percentage, recent classes
   â”‚
   â”œâ”€â†’ Attendance Overview
   â”‚   â”œâ”€â†’ Daily View
   â”‚   â”‚   â””â”€â†’ Query: attendance collection (by date & roll)
   â”‚   â”‚   â””â”€â†’ Shows: Classes for specific date
   â”‚   â”‚
   â”‚   â”œâ”€â†’ Weekly View
   â”‚   â”‚   â””â”€â†’ Query: attendance collection (7-day range)
   â”‚   â”‚   â””â”€â†’ Shows: Weekly summary with trends
   â”‚   â”‚
   â”‚   â””â”€â†’ Monthly View
   â”‚       â””â”€â†’ Query: attendance collection (30-day range)
   â”‚       â””â”€â†’ Shows: Monthly trends and patterns
   â”‚
   â”œâ”€â†’ ID Card Generation
   â”‚   â””â”€â†’ Reads: students collection (profile)
   â”‚   â””â”€â†’ Reads: academic_records (GPA, year)
   â”‚   â””â”€â†’ Generates: Digital ID with barcode
   â”‚
   â””â”€â†’ Profile Management
       â””â”€â†’ Reads: students collection
       â””â”€â†’ Writes: students collection (updates)

3. FACULTY WORKFLOW
   â”œâ”€â†’ FacultyDashboard
   â”‚   â”œâ”€â†’ Reads: faculty collection (own uid)
   â”‚   â”œâ”€â†’ Reads: faculty_timetables (today's classes)
   â”‚   â””â”€â†’ Shows: Today's classes, quick stats
   â”‚
   â”œâ”€â†’ Attendance Setup (One-time per class)
   â”‚   â”œâ”€â†’ Step 1: Load metadata
   â”‚   â”‚   â””â”€â†’ Read: system_metadata/class_structure (one read)
   â”‚   â”‚   â””â”€â†’ Gets: Available years, branches, sections
   â”‚   â”‚
   â”‚   â”œâ”€â†’ Step 2: Select year/branch/section
   â”‚   â”‚   â””â”€â†’ Read: branch_subjects/{BRANCH}_{YEAR}
   â”‚   â”‚   â””â”€â†’ Gets: Available subjects for that class
   â”‚   â”‚
   â”‚   â”œâ”€â†’ Step 3: Select subject & period
   â”‚   â”‚   â””â”€â†’ Faculty selects subject, period, period count
   â”‚   â”‚   â””â”€â†’ Query: students collection (filter by year/branch/section)
   â”‚   â”‚   â””â”€â†’ Gets: All students in that class
   â”‚   â”‚
   â”‚   â””â”€â†’ Step 4: Create attendance session
   â”‚       â””â”€â†’ Write: attendance collection (new document)
   â”‚       â””â”€â†’ Fields: Enrolled student IDs, subject, faculty, timestamp
   â”‚
   â”œâ”€â†’ Attendance Scanner
   â”‚   â””â”€â†’ Live Camera Feed
   â”‚       â”œâ”€â†’ Student barcode scanned (roll number detected)
   â”‚       â”œâ”€â†’ Verify: Roll number matches enrolled students
   â”‚       â”œâ”€â†’ Add: Roll number to presentStudentIds array
   â”‚       â””â”€â†’ Update: attendance collection (real-time UI)
   â”‚
   â””â”€â†’ Reports & Analytics
       â”œâ”€â†’ Attendance Report
       â”‚   â””â”€â†’ Query: attendance collection (by date range)
       â”‚   â””â”€â†’ Filter: By subject, branch, section
       â”‚   â””â”€â†’ Shows: Student-wise, class-wise stats
       â”‚
       â””â”€â†’ Long-term Reports
           â””â”€â†’ Aggregate: attendance_summaries data
           â””â”€â†’ Shows: Monthly/semester trends

4. DATA SYNCHRONIZATION
   â”œâ”€â†’ Offline First
   â”‚   â””â”€â†’ Firestore persistence enabled
   â”‚   â””â”€â†’ App works offline, syncs when online
   â”‚
   â”œâ”€â†’ Real-time Updates
   â”‚   â””â”€â†’ Scanner updates attendance as students arrive
   â”‚   â””â”€â†’ Students see live class view
   â”‚
   â””â”€â†’ Summary Updates
       â””â”€â†’ After attendance session ends
       â””â”€â†’ Calculate & update attendance_summaries
       â””â”€â†’ Update academic_records if needed
```

---

## ğŸ” User Authentication Flow

### **Authentication Architecture**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           LOGIN SCREEN (Flutter App)                 â”‚
â”‚  - Email input field                                â”‚
â”‚  - Password input field                             â”‚
â”‚  - Login button                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    LoginController (State Mgmt)      â”‚
    â”‚  - Manages loading state             â”‚
    â”‚  - Notifies listeners of changes     â”‚
    â”‚  - Validates input                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  LoginService (Business Logic)  â”‚
         â”‚  - Calls Auth Server            â”‚
         â”‚  - Handles responses            â”‚
         â”‚  - Error management             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                              â”‚
            â†“                              â†“
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Auth Server            â”‚  â”‚   Database (Firestore)   â”‚
 â”‚  (Port 9002, Local)      â”‚  â”‚                          â”‚
 â”‚                          â”‚  â”‚  Verifies credentials:   â”‚
 â”‚  Verifies credentials:   â”‚  â”‚  - Students collection   â”‚
 â”‚  - Check in database     â”‚  â”‚  - Faculty collection    â”‚
 â”‚  - Email format valid    â”‚  â”‚  - Role field exists     â”‚
 â”‚  - Password matches      â”‚  â”‚                          â”‚
 â”‚  - User role determined  â”‚  â”‚  Returns:                â”‚
 â”‚                          â”‚  â”‚  - User data with role   â”‚
 â”‚  Issues:                 â”‚  â”‚  - Email verification    â”‚
 â”‚  - Custom JWT token      â”‚  â”‚                          â”‚
 â”‚    with role claims      â”‚  â”‚                          â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Firebase Auth              â”‚
     â”‚ (Cloud Authentication)       â”‚
     â”‚                              â”‚
     â”‚ - Validates JWT token        â”‚
     â”‚ - Creates auth session       â”‚
     â”‚ - Returns Firebase User      â”‚
     â”‚ - Sets auth state            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   RoleRouter                 â”‚
         â”‚  - Checks user.role          â”‚
         â”‚  - Routes to appropriate UI  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                              â”‚
            â†“                              â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  StudentShell    â”‚         â”‚  FacultyShell    â”‚
   â”‚ (4-tab nav)      â”‚         â”‚ (3-tab nav)      â”‚
   â”‚ - Dashboard      â”‚         â”‚ - Dashboard      â”‚
   â”‚ - Attendance     â”‚         â”‚ - Scanner        â”‚
   â”‚ - ID Card        â”‚         â”‚ - Reports        â”‚
   â”‚ - Profile        â”‚         â”‚ - Timetable      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Key Authentication Files**

| File | Purpose |
|------|---------|
| [auth/login/login_screen.dart](lib/auth/login/login_screen.dart) | Login UI |
| [auth/login/login_controller.dart](lib/auth/login/login_controller.dart) | State management |
| [auth/login/login_service.dart](lib/auth/login/login_service.dart) | Server communication |
| [auth/role_router.dart](lib/auth/role_router.dart) | Route by role |
| [services/firebase_auth_service.dart](lib/services/firebase_auth_service.dart) | Firebase Auth wrapper |

### **Authentication Data Storage**

- **Firebase Auth**: Stores UID, email, auth state
- **Firestore students collection**: Role = "student", plus profile data
- **Firestore faculty collection**: Role = "faculty", plus profile data
- **Auth Server**: Verifies credentials against database

---

## ğŸ“± Attendance Marking Workflow

### **Step-by-Step Attendance Process**

#### **Phase 1: Faculty Setup (Before Class)**

```
Step 1: Load Configuration
  Input: (None - automatic on app launch)
  Operation:
    - Read: system_metadata/class_structure
    - Store in memory: Available years, branches, sections
  Output: Dropdown options loaded
  Firestore Reads: 1

Step 2: Select Class
  Input: Year, Branch, Section
  Operation:
    - Validate selections not null
    - Read: branch_subjects/{BRANCH}_{YEAR}
    - Extract: Subjects for selected year/branch
    - Store: Available subjects with display names
  Output: Subject dropdown populated
  Firestore Reads: 1 per selection

Step 3: Select Subject & Period
  Input: Subject name, Period number (1-7), Period count, Lab flag
  Operation:
    - Validate: Subject exists in selected class
    - Query: students collection
      - Filter: year, branch, section match
      - Build: List of all student roll numbers
    - Store: enrolledStudentIds list
  Output: Ready for attendance marking
  Firestore Reads: 1 query on students collection

Step 4: Create Attendance Session
  Input: All selections from steps 1-3
  Operation:
    - Create attendance document:
      {
        "subjectCode": selected subject code,
        "subjectName": selected subject name,
        "facultyId": current user's uid,
        "facultyName": current user's name,
        "timestamp": now,
        "date": today's date (YYYY-MM-DD),
        "periodNumber": selected period,
        "periodCount": selected period count,
        "isLab": true/false,
        "enrolledStudentIds": [list of all students],
        "presentStudentIds": [],
        "branch": selected branch,
        "section": selected section,
        "year": selected year
      }
    - Write to: attendance collection
    - Get back: Attendance document ID
  Output: Session created, ready for scanning
  Firestore Writes: 1
```

#### **Phase 2: Live Attendance Marking (During Class)**

```
Step 1: Scan Student Barcode
  Input: Student rolls barcode image (from camera)
  Operation:
    - mobile_scanner captures image
    - Extract: Roll number from barcode
    - Validate: Roll number in enrolledStudentIds array
    - If valid:
      - Check if already marked present
      - If not: Add roll number to presentStudentIds array
      - Update: attendance document
      - Notify UI: Student marked, show visual feedback
    - If invalid: Show error, prompt rescan
  Output: Student added to present list
  Firestore Writes: 1 per unique student (Batch updates)

Step 2: Real-time UI Update
  Operation:
    - Display current present count vs total enrolled
    - Show marked students list
    - Update percentage attendance live
  Output: Faculty sees real-time progress

Step 3: Session Management
  Operations:
    - Can add/remove students manually if needed
    - Can mark attendance complete
    - Can cancel if needed
  Validation:
    - Before marking complete: Must have scanned at least 1 student
    - Enrolled count must match query results
```

#### **Phase 3: Session Completion & Summary Update**

```
Step 1: Mark Session Complete
  Input: Faculty clicks "Mark Attendance Complete"
  Operation:
    - Validate: presentStudentIds list not empty
    - Calculate: Attendance percentage for session
    - Update: attendance document
      - Set: "isActive": false
      - Set: "endTime": now
    - Create batch operation for summaries
  Firestore Writes: 1 (update document)

Step 2: Update Attendance Summaries
  Operation:
    - For each presentStudentId:
      - Read: attendance_summaries/{rollNumber}
      - Update: 
        - totalClasses += periodCount
        - presentClasses += periodCount
        - lastUpdated: now
        - Add to subjectWiseSummary
      - Write: Updated document
    - For each absentStudentId:
      - Read: attendance_summaries/{rollNumber}
      - Update:
        - totalClasses += periodCount
        - absentClasses += periodCount
        - lastUpdated: now
      - Write: Updated document
  Firestore Writes: N (where N = total enrolled students)
  Firestore Reads: N

Step 3: Update Academic Records (Optional)
  Operation:
    - Check: Is attendance below minimum threshold?
    - If yes: Flag in academic_records for warning
  Firestore Writes: Optional N records
```

### **Attendance Query Examples**

```dart
// Get all attendance for a student
collection('attendance')
  .where('enrolledStudentIds', arrayContains: '2024001')
  .orderBy('timestamp', descending: true)
  .limit(100)

// Get attendance for a specific date
collection('attendance')
  .where('date', isEqualTo: '2024-01-20')
  .where('enrolledStudentIds', arrayContains: '2024001')

// Get attendance for a date range
collection('attendance')
  .where('enrolledStudentIds', arrayContains: '2024001')
  .where('date', isGreaterThanOrEqualTo: '2024-01-01')
  .where('date', isLessThanOrEqualTo: '2024-01-31')
  .orderBy('date')

// Get attendance for a subject
collection('attendance')
  .where('subjectCode', isEqualTo: 'CS101')
  .where('enrolledStudentIds', arrayContains: '2024001')
```

---

## ğŸ”— Data Relationships

### **Entity Relationship Diagram**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   students   â”‚                      â”‚   faculty    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UID)     â”‚â—„â”€â”€â”€â”€â”€Foreign Keyâ”€â”€â”€â”€â”€â”‚ id (UID)     â”‚
â”‚ uid          â”‚                      â”‚ uid          â”‚
â”‚ name         â”‚                      â”‚ name         â”‚
â”‚ rollNumber   â”‚                      â”‚ employeeId   â”‚
â”‚ email        â”‚                      â”‚ email        â”‚
â”‚ department   â”‚                      â”‚ department   â”‚
â”‚ year         â”‚                      â”‚ assignedSubj.â”‚
â”‚ section      â”‚                      â”‚ createdAt    â”‚
â”‚ enrolledSubj â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ createdAt    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Has Many
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   attendance     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (auto)        â”‚
â”‚ studentId (FK)   â”‚â”€â”€â†’ references students.id (via roll number lookup)
â”‚ facultyId (FK)   â”‚â”€â”€â†’ references faculty.id
â”‚ subjectCode      â”‚â”€â”€â†’ references branch_subjects.subjects[].code
â”‚ timestamp        â”‚
â”‚ date             â”‚
â”‚ enrolledStudents â”‚
â”‚ presentStudents  â”‚
â”‚ status           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Aggregates to
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  attendance_summaries    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ rollNumber (student)     â”‚
â”‚ totalClasses             â”‚
â”‚ presentClasses           â”‚
â”‚ percentage               â”‚
â”‚ subjectWiseSummary {}    â”‚
â”‚ monthlyBreakdown {}      â”‚
â”‚ lastUpdated              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Other Related Collections:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ branch_subjects  â”‚         â”‚ faculty_timetablesâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ branch_year (ID) â”‚         â”‚ facultyId (ID)    â”‚
â”‚ subjects []      â”‚         â”‚ timetable {}      â”‚
â”‚ â”œâ”€ code          â”‚         â”‚ lastUpdated       â”‚
â”‚ â”œâ”€ name          â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”œâ”€ credits       â”‚
â”‚ â”œâ”€ isLab         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â””â”€ periodCount   â”‚         â”‚ system_metadata  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                             â”‚ class_structure  â”‚
                             â”‚ â”œâ”€ years []      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”œâ”€ branches []   â”‚
â”‚ academic_records â”‚         â”‚ â””â”€ sections []   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ rollNumber (ID)  â”‚
â”‚ studentId        â”‚
â”‚ semesters []     â”‚
â”‚ overallCGPA      â”‚
â”‚ lastUpdated      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Cross-Collection References**

| From Collection | Field | References | Relationship |
|-----------------|-------|-----------|--------------|
| `attendance` | `studentId` | `students.uid` | Each attendance belongs to 1 student |
| `attendance` | `facultyId` | `faculty.uid` | Each attendance created by 1 faculty |
| `attendance` | `subjectCode` | `branch_subjects.subjects[].code` | References subject catalog |
| `attendance_summaries` | `rollNumber` | `students.rollNumber` | Summarizes student's all attendance |
| `attendance_summaries` | `studentId` | `students.uid` | Links to student document |
| `academic_records` | `rollNumber` | `students.rollNumber` | Academic progress of student |
| `faculty_timetables` | `facultyId` | `faculty.uid` | Faculty's teaching schedule |
| `branch_subjects` | `branch_year` | Implicit (CSE_4) | Subjects for branch-year |
| `students` | `enrolledSubjects` | `branch_subjects.subjects[].code` | Array of subject codes |
| `faculty` | `assignedSubjects` | `branch_subjects.subjects[].code` | Array of subject codes |

---

## âš™ï¸ System Metadata & Configuration

### **Configuration Management**

The system uses the `system_metadata` collection with document `class_structure` to centralize configuration:

```json
{
  "years": [1, 2, 3, 4],
  "branches": ["CSE", "AIML", "ECE", "MECH"],
  "sections": ["A", "B", "C"],
  "maxPeriods": 7,
  "periodDuration": 60,
  "academicYear": "2023-24"
}
```

**Benefits**:
- âœ… Single read loads all metadata (1 Firestore read)
- âœ… Easy admin updates without app restart
- âœ… All dropdowns generated from single source of truth
- âœ… Cost-efficient (metadata is tiny ~1KB)

### **Cost Optimization Strategy**

| Operation | Collections | Read Count | Optimization |
|-----------|-----------|-----------|---|
| Load metadata | system_metadata | 1 | âœ… Cached in memory |
| Load branch subjects | branch_subjects | 1 per selection | âœ… Single read, not per-subject |
| Get student data | students | 1 | âœ… Direct UID access |
| Get attendance | attendance | 1 query | âœ… Indexed on enrolledStudentIds |
| Get summaries | attendance_summaries | 1 direct | âœ… Keyed by roll number |
| Scan student | attendance | 1 write | âœ… Batch updates in transaction |

**Key Principles**:
- âœ… One-time metadata reads at startup
- âœ… Direct access by ID whenever possible
- âœ… Batch writes for multiple student updates
- âœ… Avoid unnecessary cascading reads
- âœ… Use arrays for efficient filtering (enrolledStudentIds, presentStudentIds)

---

## ğŸ“Š Summary Table: Which Collection is Used For What

| Feature | Primary Collections Used | Read/Write Pattern | Key Operations |
|---------|-------------------------|-------------------|-----------------|
| **User Login** | `students` / `faculty` | Read | Verify credentials, load profile |
| **Student Dashboard** | `students`, `attendance_summaries` | Read | Show profile, attendance stats |
| **Attendance View (Daily)** | `attendance` | Query by date | Show classes for specific day |
| **Attendance View (Weekly)** | `attendance` | Query by date range | 7-day attendance summary |
| **Attendance View (Monthly)** | `attendance` | Query by date range | 30-day attendance trends |
| **Student ID Card** | `students`, `academic_records` | Read | Display profile, GPA, barcode |
| **Faculty Dashboard** | `faculty`, `faculty_timetables` | Read | Show today's classes, quick stats |
| **Timetable View** | `faculty_timetables` | Read | Display teaching schedule |
| **Attendance Setup** | `system_metadata`, `branch_subjects`, `students` | Read | Get config, subjects, enroll students |
| **Attendance Scanner** | `attendance` | Write | Add present students in real-time |
| **Attendance Summary** | `attendance_summaries` | Read/Write | Display & update statistics |
| **Attendance Reports** | `attendance` | Query | Generate reports by date/subject |
| **Profile Update** | `students` / `faculty` | Update | Save profile changes |
| **Academic Records** | `academic_records` | Read | View grades and CGPA |

---

## ğŸ“ Key Service Files

| File | Collections Used | Purpose |
|------|-----------------|---------|
| [services/firestore_service.dart](lib/services/firestore_service.dart) | `students`, `faculty`, `faculty_timetables` | Generic Firestore CRUD |
| [services/attendance_service.dart](lib/services/attendance_service.dart) | `attendance`, `attendance_summaries` | Attendance queries & updates |
| [services/firebase_auth_service.dart](lib/services/firebase_auth_service.dart) | Firebase Auth | Authentication |
| [faculty/setup/faculty_setup_controller.dart](lib/faculty/setup/faculty_setup_controller.dart) | `system_metadata`, `branch_subjects`, `students` | Setup attendance session |

---

## ğŸ” Document ID Patterns

| Collection | Document ID Pattern | Example | How it's accessed |
|-----------|-------------------|---------|-----------------|
| `users` | Firebase UID | `abc123xyz` | Direct access by UID |
| `students` | Firebase UID | `abc123xyz` | Direct access by UID |
| `faculty` | Firebase UID | `xyz789abc` | Direct access by UID |
| `attendance` | Auto-generated | `doc_12345abc` | Query by fields |
| `attendance_summaries` | Roll number | `2024001` | Direct access by roll no |
| `academic_records` | Roll number | `2024001` | Direct access by roll no |
| `branch_subjects` | Branch_Year | `CSE_4` | Direct access by pattern |
| `faculty_timetables` | Faculty UID | `xyz789abc` | Direct access by UID |
| `system_metadata` | Config key | `class_structure` | Direct access by key |

---

## ğŸ“Œ Important Notes

1. **Offline Capability**: Firestore persistence is enabled in `main.dart`, allowing offline access to cached data
2. **Real-time Updates**: Scanner uses real-time Firestore updates for attendance marking
3. **No Listeners**: Most reads are one-time fetches to minimize Firestore costs
4. **Denormalization**: Faculty name stored in attendance records for quick display without join operations
5. **Array Queries**: `enrolledStudentIds` and `presentStudentIds` use array-contains for efficient queries
6. **Date Formatting**: Dates stored as YYYY-MM-DD strings for easy range queries
7. **Batch Operations**: Multiple student updates (summaries) should use batch writes for atomicity

---

**Document Version**: 1.0  
**Last Updated**: January 29, 2026  
**Maintained By**: Development Team
